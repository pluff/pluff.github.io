
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Decorate your models in two ways - Addicted to Ruby, In love the Web</title>
  <meta name="author" content="Pavel Shutsin">

  
  <meta name="description" content="Common decorator implementations under the scope. Step by step implementation, pros and cons, benchmarks, tips & tricks.">
  <meta name="keywords" content="ruby, decorator pattern, decorator, presenters, benchmark, graper, active_decorator, ruby decorator gem, mvc">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link href="//netdna.bootstrapcdn.com/font-awesome/3.1.1/css/font-awesome.css" rel="stylesheet" type="text/css" media="all">
  <link rel="index" href="http://shutsin.com" title="Addicted to Ruby, In love the Web">
  <link rel="canonical"href="http://shutsin.com/2014/03/04/decorate-your-models-in-two-ways">
  <link href="/favicon.ico" rel="icon" type="image/png">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Addicted to Ruby, In love the Web" type="application/atom+xml">
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script src="/javascripts/libs/bootstrap.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-41905992-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body >
<nav role="navigation"><div class="navbar navbar-fixed-top top-bar">
    <div class="navbar-inner">
        <div class="logo">
            <img src="http://www.gravatar.com/avatar/b7a9682d4568c1313664f46432459f0c.png?size=64" width="32" height="32" />
        </div>
        <a class="brand" href="http://shutsin.com" rel="author">Pavel Shutsin</a>
        <ul class="nav">
            <li>
                <a href="https://github.com/pluff" rel="me" target="_blank">
                    <i class="icon-2x icon-github"></i>
                </a>
            </li>
            <li>
                <a href="http://www.linkedin.com/in/shutsin" rel="me" target="_blank">
                    <i class="icon-2x icon-linkedin"></i>
                </a>
            </li>
            <li>
                <a href="http://www.facebook.com/pavel.shutin" rel="me" target="_blank">
                    <i class="icon-2x icon-facebook"></i>
                </a>
            </li>
            <li>
                <a href="https://plus.google.com/105872229152743598110?rel=author" rel="me" target="_blank">
                    <i class="icon-2x icon-google-plus-sign"></i>
                </a>
            </li>
        </ul>
    </div>
</div>


</nav>
<div class="container">
    <div class="row-fluid">
        <div class="span3 pull-right"><div class="info-block">
    <div class="about hidden-phone">
        <div class="header">
            <h4>About me</h4>
        </div>
        <div class="body">
            <img src="http://www.gravatar.com/avatar/b7a9682d4568c1313664f46432459f0c.png?size=128">
            <div class="clearfix"></div>
            <p>
                My name is Pavel Shutsin and I'm
                <a href="http://www.ruby-lang.org/">Ruby</a>
                addicted from Belarus. You can check out more info in my social accounts listed above.
            </p>
        </div>
    </div>
    <div class="recent">
        <h4>Recent Posts</h4>
        <ul>
            
            <li><a href="/2014/03/04/decorate-your-models-in-two-ways/">Decorate your models in two ways</a></li>
            
            <li><a href="/2013/10/18/rails-and-background-jobs/">Rails and background jobs</a></li>
            
            <li><a href="/2013/09/08/another-git-branching-model/">Another git branching model</a></li>
            
        </ul>
    </div>
    <div class="tags">
        <h4>Tags Cloud</h4>
        <a style='font-size: 10px' href='/tags/#Resque'>Resque</a>
<a style='font-size: 10px' href='/tags/#background jobs'>background jobs</a>
<a style='font-size: 10px' href='/tags/#decorator'>decorator</a>
<a style='font-size: 10px' href='/tags/#development workflow'>development workflow</a>
<a style='font-size: 10px' href='/tags/#git'>git</a>
<a style='font-size: 10px' href='/tags/#github'>github</a>
<a style='font-size: 10px' href='/tags/#mvc'>mvc</a>
<a style='font-size: 10px' href='/tags/#rails'>rails</a>
<a style='font-size: 20px' href='/tags/#ruby'>ruby</a>

    </div>
    <div>
        <h4>Archives</h4>
        <ul>
            
                
                
                    
                    <li><a href="/archives#March2014">March 2014</a></li>
                
                
            
                
                
                    
                    <li><a href="/archives#October2013">October 2013</a></li>
                
                
            
                
                
                    
                    <li><a href="/archives#September2013">September 2013</a></li>
                
                
            
        </ul>

    </div>
</div>
</div>
        <div class="span9"><div itemscope itemtype="http://schema.org/Article">
    
<div>
    <p class="meta">
        
        <a class="pull-left" href="/2013/10/18/rails-and-background-jobs/"
           title="Previous Post: Rails and background jobs"><i class="icon-arrow-left"></i>
            Rails and background jobs</a>
        
        
    </p>
    <div class="clearfix"></div>
</div>


    

<div class="article">
    <div class="header">
        <div class="date pull-right" itemprop="datePublished" content="2014-03-04">Mar 4<span>th</span>, 2014</div>
        <h3 itemprop="name"><a href="/2014/03/04/decorate-your-models-in-two-ways/" rel="bookmark">Decorate Your Models in Two Ways</a></h3>

        <div class="clearfix"></div>
    </div>
    <div class="body user-markup"><p><img src="/images/2014-03-04-decorate-your-models-in-two-ways.png" class="center" itemprop="image"></p>

<h4>Intro</h4>

<p><a href="http://en.wikipedia.org/wiki/Decorator_pattern">Decorator</a> is a common design pattern which allows us to add behavior to individual objects.
Ruby simplicity and flexibility provides several ways to implement it. Today we will write couple implementations and will do a bit of analysis of existing gems.</p>

<h4>Keep our model as clean as we can</h4>

<p>In MVC world it&rsquo;s widely used for adding presentation logic methods to a model without polluting model class. Let&rsquo;s say we have very simple <code>User</code> model:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">User</span>
</span><span class='line'>  <span class="kp">attr_accessor</span> <span class="ss">:first_name</span><span class="p">,</span> <span class="ss">:last_name</span><span class="p">,</span> <span class="ss">:title</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>And we have brand new special logic that states &ldquo;User&rsquo;s full name should be displayed as blablabla&rdquo;.
Sample solution can be something like that:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">User</span>
</span><span class='line'>  <span class="kp">attr_accessor</span> <span class="ss">:first_name</span><span class="p">,</span> <span class="ss">:last_name</span><span class="p">,</span> <span class="ss">:title</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">full_name</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">title</span> <span class="o">==</span> <span class="s2">&quot;Doctor&quot;</span>
</span><span class='line'>      <span class="s2">&quot;</span><span class="si">#{</span><span class="n">title</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">first_name</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">last_name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">title</span>
</span><span class='line'>      <span class="s2">&quot;</span><span class="si">#{</span><span class="n">first_name</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">last_name</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">title</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="s2">&quot;</span><span class="si">#{</span><span class="n">first_name</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">last_name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Short and simple, however it provides one nasty side effect as your project grows.</p>

<!-- more -->


<p>Imagine there are 50 of similar methods for various view-related stuff. Your model will become a mess in a blink of an eye!
If you came from Rails world you can use Rails helpers and move all representation methods there:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">MyHelpers</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">user_full_name</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class='line'>   <span class="c1">#code</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="c1">#...</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="c1">#and then in views &lt;%= user_full_name(user) %&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>That will work, however it&rsquo;s hard to maintain and it goes against Ruby object oriented nature.
Another solution could be to move all extra methods to a separate module and include in our class</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">User</span>
</span><span class='line'>  <span class="kp">attr_accessor</span> <span class="ss">:first_name</span><span class="p">,</span> <span class="ss">:last_name</span><span class="p">,</span> <span class="ss">:title</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">include</span> <span class="no">UserViewMethods</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This solutions works fine, but it still adds plenty of methods to your User class even when you might not need it.
We can do better than that! We can keep our models as clean as we can and move our view helpers to another layer.</p>

<h4>Wrap me a model please</h4>

<p>Lets create a new class <code>UserDecorator</code> that wraps our User object and add additional method on top of it.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">UserDecorator</span>
</span><span class='line'>  <span class="kp">attr_accessor</span> <span class="ss">:user</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@user</span> <span class="o">=</span> <span class="n">user</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">full_name</span>
</span><span class='line'>    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">title</span> <span class="o">==</span> <span class="s1">&#39;Doctor&#39;</span>
</span><span class='line'>      <span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@user</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="vi">@user</span><span class="o">.</span><span class="n">first_name</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="vi">@user</span><span class="o">.</span><span class="n">last_name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">title</span>
</span><span class='line'>      <span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@user</span><span class="o">.</span><span class="n">first_name</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="vi">@user</span><span class="o">.</span><span class="n">last_name</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="vi">@user</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@user</span><span class="o">.</span><span class="n">first_name</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="vi">@user</span><span class="o">.</span><span class="n">last_name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="c1">#Usage example</span>
</span><span class='line'><span class="n">decorated_user</span> <span class="o">=</span> <span class="no">UserDecorator</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">)</span>
</span><span class='line'><span class="n">decorated_user</span><span class="o">.</span><span class="n">user</span>
</span><span class='line'><span class="n">decorated_user</span><span class="o">.</span><span class="n">full_name</span>
</span></code></pre></td></tr></table></div></figure>


<p>Whenever we want to call a method on a model itself we have to write <code>decorated_user.user.my_method</code> which is so inconvinient!
We can get rid of it with mighty <code>method_missing</code>!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">UserDecorator</span>
</span><span class='line'>  <span class="c1">#...</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">method_missing</span><span class="p">(</span><span class="nb">method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@user</span><span class="o">.</span><span class="n">public_send</span><span class="p">(</span><span class="nb">method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="c1">#Usage example</span>
</span><span class='line'><span class="n">decorated_user</span> <span class="o">=</span> <span class="no">UserDecorator</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">)</span>
</span><span class='line'><span class="n">decorated_user</span><span class="o">.</span><span class="n">first_name</span> <span class="c1">#delegates to User#first_name</span>
</span><span class='line'><span class="n">decorated_user</span><span class="o">.</span><span class="n">full_name</span>
</span></code></pre></td></tr></table></div></figure>


<p>Feels much better! Now our decorator pretends to be a User and delegates all undefined method calls to user object. Oh wait a second&hellip;
<code>decorated_user.respond_to? :first_name #=&gt; false</code> ouch!
<code>respond_to?</code> returns false unless there is a defined method on our class,
so we need UserDecorator to be a little bit more like User and treat all User.instance_methods as its own.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">UserDecorator</span>
</span><span class='line'>  <span class="c1">#...</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">method_missing</span><span class="p">(</span><span class="nb">method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@user</span><span class="o">.</span><span class="n">public_send</span><span class="p">(</span><span class="nb">method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">respond_to?</span><span class="p">(</span><span class="nb">method</span><span class="p">)</span>
</span><span class='line'>    <span class="k">super</span> <span class="o">||</span> <span class="vi">@user</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="nb">method</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>One step closer to success! Obviously we can delegate class methods and constants to User class as well.
This approach is implemented in most popular presenters gem for Rails called <a href="https://github.com/drapergem/draper">Draper</a>.
You can check <a href="https://github.com/drapergem/draper/blob/594816661e0c6c48d6137f4472b8c731c3dd8df8/lib/draper/automatic_delegation.rb">this file</a> for details.
Draper is great and very rich featured gem, but imvho it&rsquo;s has a bit of &ldquo;swiss army knife&rdquo; syndrome.</p>

<p>There are couple weak places in this approach:</p>

<ol>
<li>Our decorator class pretends to be a User but it&rsquo;s not a User! <code>decorated_user.is_a? User #=&gt; false</code></li>
<li><code>method_missing</code> is relatively slow. See below for benchmarks.</li>
</ol>


<p>Let&rsquo;s think a bit how we can decorate our model even better.</p>

<h4>Extend me if you want!</h4>

<p>As it was mentioned before we can create a module and move all presentation methods there. But should we include it in class definition?
Can we add these methods to our model only when we really need it? Yes we can!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">User</span>
</span><span class='line'>  <span class="kp">attr_accessor</span> <span class="ss">:first_name</span><span class="p">,</span> <span class="ss">:last_name</span><span class="p">,</span> <span class="ss">:title</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">UserDecorator</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">full_name</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">title</span> <span class="o">==</span> <span class="s1">&#39;Doctor&#39;</span>
</span><span class='line'>      <span class="s2">&quot;</span><span class="si">#{</span><span class="n">title</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">first_name</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">last_name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">title</span>
</span><span class='line'>      <span class="s2">&quot;</span><span class="si">#{</span><span class="n">first_name</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">last_name</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">title</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="s2">&quot;</span><span class="si">#{</span><span class="n">first_name</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">last_name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we can add presentation methods to our object right before we need them(e.g. right before rendering a view).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="c1"># do something with clean model object</span>
</span><span class='line'><span class="n">user</span><span class="o">.</span><span class="n">extend</span> <span class="no">UserDecorator</span> <span class="c1">#now we have additional methods in this particular instance</span>
</span><span class='line'><span class="n">user</span><span class="o">.</span><span class="n">full_name</span> <span class="c1">#=&gt; String object</span>
</span><span class='line'><span class="n">another_user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="n">another_user</span><span class="o">.</span><span class="n">full_name</span> <span class="c1">#=&gt; exception. User class has no such method.</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can also overwrite base User methods here too for your particular object if you want.
This approach allows us to add presentational methods per instance and keep our model class clean.
Our decorated object does not pretend to be a User anymore, it is a User!
Second most popular gem for Rails presenters called <a href="https://github.com/amatsuda/active_decorator">active_decorator</a> has similar implementation with some additional features.
You can check <a href="https://github.com/amatsuda/active_decorator/blob/af3b6c60718106496b4acacd816325b00cfb873a/lib/active_decorator/decorator.rb#L31">this file</a> for details.</p>

<p>Of course there is no free cheese in this world, and we need to pay the price.</p>

<p>Week places of this approach:</p>

<ol>
<li>calling Object#extend is expensive.</li>
</ol>


<h4>Passing additional params to our decorators</h4>

<p>In real world there are use cases when you need additional params in your representation methods.
With decoration &ldquo;wrapper&rdquo; class it&rsquo;s as easy as adding additional parameters to initialize method.
With &ldquo;extending&rdquo; it&rsquo;s a little bit more complex since you can&rsquo;t pass additional params to extend method, so you have to add them after extending.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">User</span>
</span><span class='line'>  <span class="kp">attr_accessor</span> <span class="ss">:first_name</span><span class="p">,</span> <span class="ss">:last_name</span><span class="p">,</span> <span class="ss">:title</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">UserDecorator</span>
</span><span class='line'>  <span class="kp">attr_accessor</span> <span class="ss">:my_param</span>
</span><span class='line'>  <span class="c1">#....</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">u</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="n">u</span><span class="o">.</span><span class="n">extend</span> <span class="no">UserDecorator</span>
</span><span class='line'><span class="n">u</span><span class="o">.</span><span class="n">my_param</span> <span class="o">=</span> <span class="mi">1</span>
</span></code></pre></td></tr></table></div></figure>


<p>Also we can encapsulate decoration logic in separate method (e.g. <code>decorate</code>)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">User</span>
</span><span class='line'>   <span class="c1">#...</span>
</span><span class='line'>   <span class="k">def</span> <span class="nf">decorate</span>
</span><span class='line'>     <span class="nb">self</span><span class="o">.</span><span class="n">extend</span> <span class="no">UserDecorator</span>
</span><span class='line'>     <span class="k">yield</span> <span class="nb">self</span> <span class="k">if</span> <span class="nb">block_given?</span>
</span><span class='line'>   <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="n">user</span><span class="o">.</span><span class="n">decorate</span> <span class="p">{</span> <span class="o">|</span><span class="n">u</span><span class="o">|</span> <span class="n">u</span><span class="o">.</span><span class="n">my_param</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Benchmarks. Can I take a nap while it works?</h4>

<p>Are you curious what&rsquo;s the real performance numbers for both approaches? I&rsquo;m too! Here is the test I used for benchmarking:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;benchmark&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">User</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">base_method</span>
</span><span class='line'>    <span class="mi">1</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">UserDecoratorClass</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@user</span> <span class="o">=</span> <span class="n">user</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">method_missing</span><span class="p">(</span><span class="nb">method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@user</span><span class="o">.</span><span class="n">send</span> <span class="nb">method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">UserDecoratorModule</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">n</span> <span class="o">=</span> <span class="mi">1_000_000</span>
</span><span class='line'><span class="no">Benchmark</span><span class="o">.</span><span class="n">bm</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
</span><span class='line'>  <span class="n">x</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;User.new&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="n">n</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="n">u</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">;</span> <span class="n">u</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'>  <span class="n">x</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;Wrap    &quot;</span><span class="p">)</span> <span class="p">{</span> <span class="n">n</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="n">u</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">;</span> <span class="no">UserDecoratorClass</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'>  <span class="n">x</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;Extend  &quot;</span><span class="p">)</span> <span class="p">{</span> <span class="n">n</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="n">u</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">;</span> <span class="n">u</span><span class="o">.</span><span class="n">extend</span> <span class="no">UserDecoratorModule</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">u_wrap</span> <span class="o">=</span> <span class="no">UserDecoratorClass</span><span class="o">.</span><span class="n">new</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="n">u_ext</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">extend</span> <span class="no">UserDecoratorModule</span>
</span><span class='line'>
</span><span class='line'><span class="no">Benchmark</span><span class="o">.</span><span class="n">bm</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
</span><span class='line'>  <span class="n">x</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;Wrap    &quot;</span><span class="p">)</span> <span class="p">{</span> <span class="n">n</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="n">u_wrap</span><span class="o">.</span><span class="n">base_method</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'>  <span class="n">x</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;Extend  &quot;</span><span class="p">)</span> <span class="p">{</span> <span class="n">n</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="n">u_ext</span><span class="o">.</span><span class="n">base_method</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>First benchmark row shows us time Ruby spends for creating simple object.
Second one represents time spent for decorating via &ldquo;wrapping&rdquo;.
Third row represents time spent for decorating via extending.
Last 2 rows represent time spent for calling <code>User#base_method</code> for &ldquo;wrapping&rdquo; and extending approaches respectively.
Here is the results:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#Ruby 1.9.3</span>
</span><span class='line'>       <span class="n">user</span>     <span class="nb">system</span>      <span class="n">total</span>        <span class="n">real</span>
</span><span class='line'><span class="no">User</span><span class="o">.</span><span class="n">new</span>  <span class="mi">0</span><span class="o">.</span><span class="mi">230000</span>   <span class="mi">0</span><span class="o">.</span><span class="mo">000000</span>   <span class="mi">0</span><span class="o">.</span><span class="mi">230000</span> <span class="p">(</span>  <span class="mi">0</span><span class="o">.</span><span class="mi">236019</span><span class="p">)</span>
</span><span class='line'><span class="no">Wrap</span>      <span class="mi">0</span><span class="o">.</span><span class="mi">530000</span>   <span class="mi">0</span><span class="o">.</span><span class="mo">000000</span>   <span class="mi">0</span><span class="o">.</span><span class="mi">530000</span> <span class="p">(</span>  <span class="mi">0</span><span class="o">.</span><span class="mi">531092</span><span class="p">)</span>
</span><span class='line'><span class="no">Extend</span>    <span class="mi">1</span><span class="o">.</span><span class="mi">390000</span>   <span class="mi">0</span><span class="o">.</span><span class="mo">010000</span>   <span class="mi">1</span><span class="o">.</span><span class="mi">400000</span> <span class="p">(</span>  <span class="mi">1</span><span class="o">.</span><span class="mi">391936</span><span class="p">)</span>
</span><span class='line'>       <span class="n">user</span>     <span class="nb">system</span>      <span class="n">total</span>        <span class="n">real</span>
</span><span class='line'><span class="no">Wrap</span>      <span class="mi">0</span><span class="o">.</span><span class="mi">330000</span>   <span class="mi">0</span><span class="o">.</span><span class="mo">000000</span>   <span class="mi">0</span><span class="o">.</span><span class="mi">330000</span> <span class="p">(</span>  <span class="mi">0</span><span class="o">.</span><span class="mi">329640</span><span class="p">)</span>
</span><span class='line'><span class="no">Extend</span>    <span class="mi">0</span><span class="o">.</span><span class="mi">100000</span>   <span class="mi">0</span><span class="o">.</span><span class="mo">000000</span>   <span class="mi">0</span><span class="o">.</span><span class="mi">100000</span> <span class="p">(</span>  <span class="mi">0</span><span class="o">.</span><span class="mi">102596</span><span class="p">)</span>
</span><span class='line'><span class="c1">#Ruby 2.1.0</span>
</span><span class='line'>       <span class="n">user</span>     <span class="nb">system</span>      <span class="n">total</span>        <span class="n">real</span>
</span><span class='line'><span class="no">User</span><span class="o">.</span><span class="n">new</span>  <span class="mi">0</span><span class="o">.</span><span class="mi">170000</span>   <span class="mi">0</span><span class="o">.</span><span class="mo">000000</span>   <span class="mi">0</span><span class="o">.</span><span class="mi">170000</span> <span class="p">(</span>  <span class="mi">0</span><span class="o">.</span><span class="mi">170953</span><span class="p">)</span>
</span><span class='line'><span class="no">Wrap</span>      <span class="mi">0</span><span class="o">.</span><span class="mi">380000</span>   <span class="mi">0</span><span class="o">.</span><span class="mo">000000</span>   <span class="mi">0</span><span class="o">.</span><span class="mi">380000</span> <span class="p">(</span>  <span class="mi">0</span><span class="o">.</span><span class="mi">383857</span><span class="p">)</span>
</span><span class='line'><span class="no">Extend</span>    <span class="mi">2</span><span class="o">.</span><span class="mi">140000</span>   <span class="mi">0</span><span class="o">.</span><span class="mo">010000</span>   <span class="mi">2</span><span class="o">.</span><span class="mi">150000</span> <span class="p">(</span>  <span class="mi">2</span><span class="o">.</span><span class="mi">144567</span><span class="p">)</span>
</span><span class='line'>       <span class="n">user</span>     <span class="nb">system</span>      <span class="n">total</span>        <span class="n">real</span>
</span><span class='line'><span class="no">Wrap</span>      <span class="mi">0</span><span class="o">.</span><span class="mi">250000</span>   <span class="mi">0</span><span class="o">.</span><span class="mo">000000</span>   <span class="mi">0</span><span class="o">.</span><span class="mi">250000</span> <span class="p">(</span>  <span class="mi">0</span><span class="o">.</span><span class="mi">241658</span><span class="p">)</span>
</span><span class='line'><span class="no">Extend</span>    <span class="mi">0</span><span class="o">.</span><span class="mi">080000</span>   <span class="mi">0</span><span class="o">.</span><span class="mo">000000</span>   <span class="mi">0</span><span class="o">.</span><span class="mi">080000</span> <span class="p">(</span>  <span class="mi">0</span><span class="o">.</span><span class="mi">083517</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>As we can see &ldquo;wrapping&rdquo; an object is almost 4 times faster (more than 9 times faster with Ruby 2.1.0).
On the other side method calls from undecorated base class is roughly 3 times faster with &ldquo;extend&rdquo; approach.
If your views use a lot of method calls per object extending will work faster.
If you have plenty of small objects and low method calls frequency &ldquo;wrapping&rdquo; will work faster for you.</p>

<h4>Conclusion</h4>

<p>There are several ways how to deal with presentation logic in Ruby. Using decoration classes is more classic well-known implementation, however it doesn&rsquo;t fits well with Ruby ideology with duck-typing and all that jazz.
Using modules and &ldquo;Object#extend&rdquo; provides us another way how to decorate our models with additional methods. It uses full power of Ruby object model and will come out with better performance in majority of use-cases.
Both methods have their weaknesses and you just need to choose what fits you better.</p>

<p>Thanks, and see you next time!</p>
</div>
    <div class="footer">
        <div class="tags pull-left">
            
                <span class="label">
                    <a href="/tags/#ruby" rel="tag">ruby</a>
                </span>
            
                <span class="label">
                    <a href="/tags/#decorator" rel="tag">decorator</a>
                </span>
            
                <span class="label">
                    <a href="/tags/#mvc" rel="tag">mvc</a>
                </span>
            
        </div>
        <div class="pull-right">
            
            <div class="sharing">
  <small>Share:</small>
  <a href="http://twitter.com/intent/tweet?text=Decorate%20your%20models%20in%20two%20ways+http%3A%2F%2Fshutsin.com%2F2014%2F03%2F04%2Fdecorate-your-models-in-two-ways%2F" title="Share in Twitter" target="_blank"><i class="icon-twitter"></i></a>
  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fshutsin.com%2F2014%2F03%2F04%2Fdecorate-your-models-in-two-ways%2F" title="Share in Facebook" target="_blank"><i class="icon-facebook"></i></a>
  <a href="https://plus.google.com/share?url=http%3A%2F%2Fshutsin.com%2F2014%2F03%2F04%2Fdecorate-your-models-in-two-ways%2F" title="Share in Google+" target="_blank"><i class="icon-google-plus-sign"></i></a>
  
  
  
</div>

            
        </div>
        <div class="clearfix"></div>

    </div>

</div>
<div class="clearfix"></div>


    
<div>
    <p class="meta">
        
        <a class="pull-left" href="/2013/10/18/rails-and-background-jobs/"
           title="Previous Post: Rails and background jobs"><i class="icon-arrow-left"></i>
            Rails and background jobs</a>
        
        
    </p>
    <div class="clearfix"></div>
</div>


    <div class="content-block-separator"></div>
    
    <div class="article-comments">
        <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

        </div>
    </div>
    
</div>
</div>
    </div>
</div>
<footer role="contentinfo"><div class="page-footer">
    <div class="text-center">
        <small>&copy; 2014 Pavel Shutsin</small>
    </div>
</div>
</footer>


<script type="text/javascript">
      var disqus_shortname = 'pluff';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://shutsin.com/2014/03/04/decorate-your-models-in-two-ways/';
        var disqus_url = 'http://shutsin.com/2014/03/04/decorate-your-models-in-two-ways/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
